<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>手写Promise - 星空海绵 - 星空浩瀚 | 海绵吸水</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="XKHM" />
  <meta name="description" content="文章类型：个人学习笔记 手写 Promise 的前提是了解 Promise/A&#43; 规范，不说倒背如流，但是基本的点还是需要掌握的。 1.Promise/A&#43;规范 原文地址：Promis" />

  <meta name="keywords" content="Hugo, 星空海绵, 前端, 工程师" />






<meta name="generator" content="Hugo 0.79.0" />


<link rel="canonical" href="https://xkhm.net/post/js%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%89%8B%E5%86%99promise/" />





<link rel="icon" href="/favicon.png" type="image/x-icon"/>











<link rel="stylesheet" href="/sass/jane.min.f1e506a781bf25d33ffc18aa6b4e972a965c58049d27d4f92b7db2e9bf28e4bf.css" integrity="sha256-8eUGp4G/JdM//Biqa06XKpZcWASdJ9T5K32y6b8o5L8=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="手写Promise" />
<meta property="og:description" content="文章类型：个人学习笔记 手写 Promise 的前提是了解 Promise/A&#43; 规范，不说倒背如流，但是基本的点还是需要掌握的。 1.Promise/A&#43;规范 原文地址：Promis" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xkhm.net/post/js%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%89%8B%E5%86%99promise/" />
<meta property="article:published_time" content="2021-01-07T21:50:29+08:00" />
<meta property="article:modified_time" content="2021-01-07T21:50:29+08:00" />
<meta itemprop="name" content="手写Promise">
<meta itemprop="description" content="文章类型：个人学习笔记 手写 Promise 的前提是了解 Promise/A&#43; 规范，不说倒背如流，但是基本的点还是需要掌握的。 1.Promise/A&#43;规范 原文地址：Promis">
<meta itemprop="datePublished" content="2021-01-07T21:50:29+08:00" />
<meta itemprop="dateModified" content="2021-01-07T21:50:29+08:00" />
<meta itemprop="wordCount" content="6646">



<meta itemprop="keywords" content="Promise,手写Promise,提桶,JavaScript," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="手写Promise"/>
<meta name="twitter:description" content="文章类型：个人学习笔记 手写 Promise 的前提是了解 Promise/A&#43; 规范，不说倒背如流，但是基本的点还是需要掌握的。 1.Promise/A&#43;规范 原文地址：Promis"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-K0V0BST0TH', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">星空海绵</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/treasury/">细品</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/interview/">提桶</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/life/">生活</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/readbook/">读书</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/technology/">技术</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/essay/">思考</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/tobedone/">Flag</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/about/">关于</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/tags/">标签</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      星空海绵
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/treasury/">细品</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/interview/">提桶</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/life/">生活</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/readbook/">读书</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/technology/">技术</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/essay/">思考</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/tobedone/">Flag</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/about/">关于</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xkhm.net/tags/">标签</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">手写Promise</h1>
      
      <div class="post-meta">
        <time datetime="2021-01-07" class="post-time">
          2021-01-07
        </time>
        <div class="post-category">
            <a href="https://xkhm.net/categories/javascript/"> JavaScript </a>
            
          </div>
        <span class="more-meta"> 约 6646 字 </span>
          <span class="more-meta"> 预计阅读 14 分钟 </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#1术语">（1）术语：</a></li>
    <li><a href="#2规范">（2）规范</a>
      <ul>
        <li><a href="#21-promise状态">2.1. Promise状态</a></li>
        <li><a href="#22-then方法">2.2. then方法</a></li>
        <li><a href="#23-promise-执行程序-解决程序">2.3. Promise 执行程序 （解决程序）</a></li>
      </ul>
    </li>
    <li><a href="#3附注">（3）附注</a>
      <ul>
        <li><a href="#31-这里的平台代码是指引擎执行环境和-promise-实现代码实际上此要求可确保在事件循环回合之后调用-onfulfilled-和-onrejected-异步执行然后使用新的堆栈进行调用可以使用-宏任务-机制如-settimeout-或-setimmediate-或-微任务-机制如-mutationobserver-或-processnexttick-来实现由于-promise-实现被视为平台代码因此它本身可能包含一个任务调度队列或trampoline在其中调用处理程序">3.1. 这里的“平台代码”是指引擎，执行环境和 <strong>promise</strong> 实现代码。实际上，此要求可确保在事件循环回合之后调用 <strong>onFulfilled</strong> 和 <strong>onRejected</strong> 异步执行，然后使用新的堆栈进行调用。可以使用 <strong>“宏任务”</strong> 机制（如 <strong>setTimeout</strong> 或 <strong>setImmediate</strong> ）或 <strong>“微任务”</strong> 机制（如 <strong>MutationObserver</strong> 或 <strong>process.nextTick</strong> ）来实现。由于 <strong>promise</strong> 实现被视为平台代码，因此它本身可能包含一个任务调度队列或“trampoline”，在其中调用处理程序。</a></li>
        <li><a href="#32-也就是说在严格模式下this-是-undefined--在非严格模式下this-是全局对象">3.2. 也就是说，在严格模式下，<strong>this</strong> 是 <strong>undefined</strong> 。 在非严格模式下，<strong>this</strong> 是全局对象。</a></li>
        <li><a href="#33-如果实现满足所有要求则实现可以允许-promise2--promise1--每个实现都应记录是否可以产生-promise2--promise1-以及在什么条件下产生">3.3. 如果实现满足所有要求，则实现可以允许 <strong>promise2 === promise1</strong> 。 每个实现都应记录是否可以产生 <strong>promise2 === promise1</strong> 以及在什么条件下产生。</a></li>
        <li><a href="#34-通常只有-x-来自当前的实现才知道它是一个真正的-promise--本节允许使用特定的实现的方式来采用已知符合-promise-的状态">3.4. 通常，只有 <strong>x</strong> 来自当前的实现，才知道它是一个真正的 <strong>promise</strong> 。 本节允许使用特定的实现的方式来采用已知符合 <strong>promise</strong> 的状态。</a></li>
        <li><a href="#35-首先存储对-xthen-的引用然后测试该引用然后调用该引用的过程避免了对-xthen-属性的多次访问-此类预防措施对于确保访问者属性的一致性非常重要因为访问者属性的值在两次检索之间可能会发生变化">3.5. 首先存储对 <strong>x.then</strong> 的引用，然后测试该引用，然后调用该引用的过程避免了对 <strong>x.then</strong> 属性的多次访问。 此类预防措施对于确保访问者属性的一致性非常重要，因为访问者属性的值在两次检索之间可能会发生变化。</a></li>
        <li><a href="#36-实现不应在可建立链的深度上设置任意限制并假定超出该任意限制则递归将是无限的-只有真正的循环才应该导致-typeerror--如果遇到无限多个不同的罐头则永远递归是正确的行为">3.6. 实现不应在可建立链的深度上设置任意限制，并假定超出该任意限制，则递归将是无限的。 只有真正的循环才应该导致 <strong>TypeError</strong> 。 如果遇到无限多个不同的罐头，则永远递归是正确的行为。</a></li>
      </ul>
    </li>
    <li><a href="#3总结">（3）总结</a></li>
  </ul>

  <ul>
    <li><a href="#1promise-状态">（1）Promise 状态</a></li>
    <li><a href="#2then方法">2.then方法</a></li>
    <li><a href="#3promise解决过程">3.Promise解决过程</a></li>
  </ul>

  <ul>
    <li><a href="#1promise内部错误被吞掉了那是被谁吞掉的呢是被reject吞掉的">（1）Promise内部错误被吞掉了，那是被谁吞掉的呢，是被reject吞掉的</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <blockquote>
<p>文章类型：个人学习笔记</p>
</blockquote>
<blockquote>
<p>手写 <strong>Promise</strong> 的前提是了解 <strong>Promise/A+</strong> 规范，不说倒背如流，但是基本的点还是需要掌握的。</p>
</blockquote>
<h1 id="1promisea规范">1.Promise/A+规范</h1>
<p>原文地址：<a href="https://promisesaplus.com/">Promise/A+规范</a></p>
<blockquote>
<p><del>提醒：翻译是采用个人理解+谷歌翻译逐字逐句翻译</del></p>
</blockquote>
<h2 id="1术语">（1）术语：</h2>
<p>1.1. <strong>“promise”</strong> 是一个带有符合此行为规范 <strong>then</strong> 方法的对象（object）或函数（function）。</p>
<p>1.2. <strong>“thenable”</strong> 是定义 <strong>then</strong> 方法的一个对象（object）或函数（function）。</p>
<p>1.3. <strong>“value”</strong> 可以是任何<strong>合法</strong>的 <strong>JavaScript</strong> 值（包括 <strong>undefined</strong>，<strong>thenable</strong>，<strong>promise</strong>）。</p>
<p>1.4. <strong>“exception”</strong> 是被 <strong>throw</strong> 语句抛出的值。</p>
<p>1.5. <strong>“reason”</strong> 是表明 promise 为什么被拒绝的值。</p>
<h2 id="2规范">（2）规范</h2>
<h3 id="21-promise状态">2.1. Promise状态</h3>
<p>一个 <strong>promise</strong> 必须处于以下三种状态之一：<strong>pending</strong>，<strong>fulFilled</strong>，或 <strong>rejected</strong>。</p>
<p><strong>2.1.1.</strong> 当 <strong>promise</strong> 为 <strong>pending</strong> 状态时：</p>
<ul>
<li>2.1.1.1. 可能会转换为 <strong>fulFilled状态</strong> 或 <strong>rejected状态</strong></li>
</ul>
<p><strong>2.1.2.</strong> 当 <strong>promise</strong> 为 <strong>fulFilled</strong> 状态时：</p>
<ul>
<li>
<p>2.1.2.1. 不能转换为任何其它状态。</p>
</li>
<li>
<p>2.1.2.2. 必须有一个 <strong>value</strong> 值，且该 <strong>value</strong> 值不能更改。</p>
</li>
</ul>
<p><strong>2.1.3.</strong> 当 <strong>promise</strong> 为 <strong>rejected</strong> 状态时：</p>
<ul>
<li>
<p>2.1.3.1. 不能转换为任何其它状态。</p>
</li>
<li>
<p>2.1.3.2.  必须有一个 <strong>reason</strong> 值，且该 <strong>reason</strong> 值不能更改。</p>
</li>
</ul>
<p>在此，“不能更改”意味着恒等不变（即：===），但并不表示更深层次的不可改变。</p>
<h3 id="22-then方法">2.2. then方法</h3>
<p>一个 <strong>Promise</strong> 必须提供一个 <strong>then</strong> 方法用来访问 <strong>当前值</strong>、最终的 <strong>value值</strong> 或 <strong>reason</strong>。</p>
<p>一个 <strong>Promise</strong> 的 <strong>then</strong> 方法接收两个参数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-JavaScript" data-lang="JavaScript"><span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">onFulfilled</span><span class="p">,</span> <span class="nx">onRejected</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>2.2.1.</strong> <strong>onFulfilled</strong> 和 <strong>onRejected</strong> 都是可选参数：</p>
<ul>
<li>
<p>2.2.1.1. 如果 <strong>onFulfilled</strong> 不是函数，则必须将其忽略。</p>
</li>
<li>
<p>2.2.1.2. 如果 <strong>onRejected</strong> 不是函数，则必须将其忽略。</p>
</li>
</ul>
<p><strong>2.2.2.</strong> 如果 <strong>onFulfilled</strong> 是一个函数：</p>
<ul>
<li>
<p>2.2.2.1. 必须在 <strong>promise</strong> 实现 <strong>fulFilled</strong> 状态后调用它，它的第一个参数是 <strong>promise</strong> 的值。</p>
</li>
<li>
<p>2.2.2.2. 不能在 <strong>promise</strong> 实现 <strong>fulFilled</strong> 状态前调用它。</p>
</li>
<li>
<p>2.2.2.3. 它不能被调用超过一次</p>
</li>
</ul>
<p><strong>2.2.3.</strong>  如果 <strong>onRejected</strong> 是一个函数：</p>
<ul>
<li>
<p>2.2.3.1. 必须在 <strong>promise</strong> 实现 <strong>rejected</strong> 状态后调用它，它的第一个参数是 <strong>reason</strong>。</p>
</li>
<li>
<p>2.2.3.2.  不能在 <strong>promise</strong> 实现 <strong>rejected</strong> 状态前调用它。</p>
</li>
<li>
<p>2.2.3.3. 它不能被调用超过一次</p>
</li>
</ul>
<p><strong>2.2.4.</strong> <strong>onFulfilled</strong> 或 <strong>onRejected</strong> 不能在执行上下文堆栈仅包含平台代码之前调用。<strong>[3.1]</strong></p>
<p><strong>2.2.5.</strong> <strong>onFulfilled</strong> 和 <strong>onRejected</strong> 必须作为函数调用（即 没有 <strong>this</strong> 值）。<strong>[3.2]</strong></p>
<p><strong>2.2.6.</strong> then 可能在同一个 promise 中被多次调用。</p>
<ul>
<li>
<p>2.2.6.1. 如果当 <strong>promise</strong> 是 <strong>fulFilled</strong> 状态时，所有 <strong>then</strong> 各自的 <strong>onFulfilled</strong> 回调必须按照其被 <strong>then</strong> 发起调用的顺序执行。</p>
</li>
<li>
<p>2.2.6.2.  如果当 <strong>promise</strong> 是 <strong>rejected</strong> 状态时，所有 <strong>then</strong> 各自的 <strong>onRejected</strong> 回调必须按照其被 <strong>then</strong> 发起调用的顺序执行。</p>
</li>
</ul>
<p><strong>2.2.7.</strong> <strong>then</strong> 必须返回一个 <strong>promise</strong> <strong>[3.3]</strong> 。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-JavaScript" data-lang="JavaScript"><span class="nx">promise2</span> <span class="o">=</span> <span class="nx">promise1</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">onFulfilled</span><span class="p">,</span> <span class="nx">onRejected</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>2.2.7.1. 如果 <strong>onFulfilled</strong> 或 <strong>onRejected</strong> 返回一个 value <strong>x</strong>，运行 promise 解决程序：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-JavaScript" data-lang="JavaScript"><span class="p">[[</span><span class="nx">Resolve</span><span class="p">]](</span><span class="nx">promise2</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>2.2.7.2. 如果 <strong>onFulfilled</strong> 或 <strong>onRejected</strong> 抛出异常 <strong>e</strong> ，<strong>promise2</strong> 必须执行 <strong>rejected</strong> 将 <strong>e</strong> 作为 <strong>reason</strong> 的值。</p>
</li>
<li>
<p>2.2.7.3. 如果 <strong>onFulfilled</strong> 不是一个函数并且 <strong>promise1</strong> 是 <strong>fulFilled</strong> 状态，<strong>promise2</strong> 必须是 <strong>fulFilled</strong> 状态且带着 <strong>promise1</strong> 同样的值。</p>
</li>
<li>
<p>2.2.7.4. 如果 <strong>onRejected</strong> 不是一个函数并且 <strong>promise1</strong> 是 <strong>rejected</strong> 状态，<strong>promise2</strong> 必须是 <strong>rejected</strong> 状态且带着 <strong>promise1</strong> 同样的 <strong>reason</strong>。</p>
</li>
</ul>
<h3 id="23-promise-执行程序-解决程序">2.3. Promise 执行程序 <del>（解决程序）</del></h3>
<p>Promise 解决程序是一个抽象操作表现为输入一个 <strong>promise</strong> 和一个 <strong>value值</strong>，我们用 <strong>[[Resolve]](promise, x)</strong> 表示，如果 <strong>x</strong> 是一个 <strong>thenable</strong>，它试图使 <strong>promise</strong> 采用 <strong>x</strong> 的状态，假设 <strong>x</strong> 的行为和 <strong>promise</strong> 类似。否则，它带着一个 value <strong>x</strong> 使 <strong>promise</strong> 转为 <strong>fulfilled</strong> 状态。</p>
<p>这种对于 <strong>thenable</strong> 的处理就允许 <strong>promise</strong> 实现互操作，只要他们暴露一个符合 <strong>Promises/A+</strong> 的 <strong>then</strong> 方法。它也允许<strong>Promises/A+</strong> 实现使用合理的 <strong>then</strong> 方法“整合”不合格的实现。</p>
<p>要运行 <strong>[[Resolve]]（promise，x）</strong>，请执行以下步骤：</p>
<p><strong>2.3.1.</strong> 如果 <strong>promise</strong> 和 <strong>x</strong> 指向同一个对象，<strong>promise</strong> 带着一个 <strong>TypeError</strong> 作为 <strong>reason</strong> 执行 <strong>reject</strong>。</p>
<p><strong>2.3.2.</strong> 如果 <strong>x</strong> 是一个 <strong>promise</strong> ，采用它的状态 <strong>[3.4]</strong> ：</p>
<ul>
<li>
<p>2.3.2.1。 如果 <strong>x</strong> 是 <strong>pending</strong> 状态，<strong>promise</strong> 必须保持 <strong>pending</strong> 状态直到 x 是 <strong>fulFilled</strong> 状态或 <strong>rejected</strong> 状态。</p>
</li>
<li>
<p>2.3.2.2. 如果当 x 是 <strong>fulfilled</strong> 状态，带着同样的 <strong>value</strong> 让 <strong>promise</strong> 变成 <strong>fulFilled</strong> 状态。</p>
</li>
<li>
<p>2.3.2.3. 如果当 x 是 <strong>rejected</strong> 状态，带着同样的 <strong>reason</strong> 让 <strong>promise</strong> 变成 <strong>rejected</strong> 状态。</p>
</li>
</ul>
<p><strong>2.3.3.</strong> 除此之外，如果 <strong>x</strong> 是一个对象或函数：</p>
<ul>
<li>
<p>2.3.3.1. 将 <strong>x.then</strong> 赋值给 <strong>then</strong>。<strong>[3.5]</strong></p>
</li>
<li>
<p>2.3.3.2. 如果使用属性 <strong>x.then</strong> 引发抛出异常 <strong>e</strong>，带着 <strong>e</strong>  作为 <strong>reason</strong> 让 <strong>promise</strong> 变成 <strong>rejected</strong> 状态。</p>
</li>
<li>
<p>2.3.3.3. 如果 <strong>then</strong> 是一个函数，用 <strong>x</strong> 作为 <strong>this</strong> 调用它，第一个参数 <strong>resolvePromise</strong>，第二个参数 <strong>rejectPromise</strong>，如下：</p>
</li>
<li>
<ul>
<li>2.3.3.3.1. 如果当 <strong>resolvePromise</strong> 带着一个 value <strong>y</strong> 被调用，执行 <strong>[[Resolve]](promise, y)</strong>。</li>
</ul>
</li>
<li>
<ul>
<li>2.3.3.3.2. 如果当 <strong>rejectPromise</strong> 带着一个 reason <strong>r</strong> 被调用，带着 <strong>r</strong>  作为 <strong>reason</strong> 让 <strong>promise</strong> 变成 <strong>rejected</strong> 状态。</li>
</ul>
</li>
<li>
<ul>
<li>2.3.3.3.3. 如果同时调用 <strong>resolvePromise</strong> 和 <strong>rejectPromise</strong> ，或者对同一参数进行了多次调用，则第一个调用优先，而所有其他调用均被忽略。</li>
</ul>
</li>
<li>
<ul>
<li>2.3.3.3.4. 如果调用 <strong>then</strong> 抛出异常 <strong>e</strong>：</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li>2.3.3.3.4.1. 如果 <strong>resolvePromise</strong> 或 <strong>rejectPromise</strong>已经被调用，请忽略它。</li>
</ul>
</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li>2.3.3.3.4.2. 否则，带着 <strong>e</strong>  作为 <strong>reason</strong> 让 <strong>promise</strong> 变成 <strong>rejected</strong> 状态。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>2.3.4.</strong> 如果 then 不是一个函数，带着 <strong>x</strong> 作为 <strong>value</strong> 让 <strong>promise</strong> 变成 <strong>fulFilled</strong> 状态。</p>
<p>如果一个 <strong>Promise</strong> 是 <strong>resolved</strong> 带着一个 <strong>thenable</strong> 在一个 <strong>thenable</strong> 循环链中，这样 <strong>[[Resolve]](promise, thenable)</strong> 的递归性质最终导致 <strong>[[Resolve]](promise, thenable)</strong> 再次被调用，遵循上述算法将导致无限递归，鼓励但不是必需的实现，以检测此类递归并以信息 <strong>TypeError</strong> 为 <strong>reason</strong> 的执行 <strong>promise</strong> 的 <strong>reject</strong>。<strong>[3.6]</strong></p>
<h2 id="3附注">（3）附注</h2>
<h3 id="31-这里的平台代码是指引擎执行环境和-promise-实现代码实际上此要求可确保在事件循环回合之后调用-onfulfilled-和-onrejected-异步执行然后使用新的堆栈进行调用可以使用-宏任务-机制如-settimeout-或-setimmediate-或-微任务-机制如-mutationobserver-或-processnexttick-来实现由于-promise-实现被视为平台代码因此它本身可能包含一个任务调度队列或trampoline在其中调用处理程序">3.1. 这里的“平台代码”是指引擎，执行环境和 <strong>promise</strong> 实现代码。实际上，此要求可确保在事件循环回合之后调用 <strong>onFulfilled</strong> 和 <strong>onRejected</strong> 异步执行，然后使用新的堆栈进行调用。可以使用 <strong>“宏任务”</strong> 机制（如 <strong>setTimeout</strong> 或 <strong>setImmediate</strong> ）或 <strong>“微任务”</strong> 机制（如 <strong>MutationObserver</strong> 或 <strong>process.nextTick</strong> ）来实现。由于 <strong>promise</strong> 实现被视为平台代码，因此它本身可能包含一个任务调度队列或“trampoline”，在其中调用处理程序。</h3>
<h3 id="32-也就是说在严格模式下this-是-undefined--在非严格模式下this-是全局对象">3.2. 也就是说，在严格模式下，<strong>this</strong> 是 <strong>undefined</strong> 。 在非严格模式下，<strong>this</strong> 是全局对象。</h3>
<h3 id="33-如果实现满足所有要求则实现可以允许-promise2--promise1--每个实现都应记录是否可以产生-promise2--promise1-以及在什么条件下产生">3.3. 如果实现满足所有要求，则实现可以允许 <strong>promise2 === promise1</strong> 。 每个实现都应记录是否可以产生 <strong>promise2 === promise1</strong> 以及在什么条件下产生。</h3>
<h3 id="34-通常只有-x-来自当前的实现才知道它是一个真正的-promise--本节允许使用特定的实现的方式来采用已知符合-promise-的状态">3.4. 通常，只有 <strong>x</strong> 来自当前的实现，才知道它是一个真正的 <strong>promise</strong> 。 本节允许使用特定的实现的方式来采用已知符合 <strong>promise</strong> 的状态。</h3>
<h3 id="35-首先存储对-xthen-的引用然后测试该引用然后调用该引用的过程避免了对-xthen-属性的多次访问-此类预防措施对于确保访问者属性的一致性非常重要因为访问者属性的值在两次检索之间可能会发生变化">3.5. 首先存储对 <strong>x.then</strong> 的引用，然后测试该引用，然后调用该引用的过程避免了对 <strong>x.then</strong> 属性的多次访问。 此类预防措施对于确保访问者属性的一致性非常重要，因为访问者属性的值在两次检索之间可能会发生变化。</h3>
<h3 id="36-实现不应在可建立链的深度上设置任意限制并假定超出该任意限制则递归将是无限的-只有真正的循环才应该导致-typeerror--如果遇到无限多个不同的罐头则永远递归是正确的行为">3.6. 实现不应在可建立链的深度上设置任意限制，并假定超出该任意限制，则递归将是无限的。 只有真正的循环才应该导致 <strong>TypeError</strong> 。 如果遇到无限多个不同的罐头，则永远递归是正确的行为。</h3>
<h2 id="3总结">（3）总结</h2>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3414b60993e34a9993edb8c7f55e3f2d~tplv-k3u1fbpfcp-watermark.image" alt=""></p>
<h1 id="2对照promisea规范手写-promise">2.对照PromiseA+规范手写 Promise</h1>
<h2 id="1promise-状态">（1）Promise 状态</h2>
<p>1.pending：待定</p>
<p>2.fulFilled：已解决</p>
<p>3.rejected：拒绝</p>
<!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-JavaScript" data-lang="JavaScript">        <span class="c1">// 1.首先 Promise 有三个状态,初始状态为pending
</span><span class="c1"></span>        <span class="c1">// 2.当 Promise 为 fulFilled 或 rejected状态时，不能转变成其它状态
</span><span class="c1"></span>        <span class="c1">// 3.当 Promise 为 fulFilled 或 rejected状态时，
</span><span class="c1"></span>        <span class="c1">// 必须有一个值（fulFilled是value,rejected是reason）
</span><span class="c1"></span>        <span class="c1">// 4.Promise 接收一个回调函数
</span><span class="c1"></span>        <span class="kd">function</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="nx">exector</span><span class="p">)</span> <span class="p">{</span>
            <span class="kr">const</span> <span class="nx">PENDING</span> <span class="o">=</span> <span class="s1">&#39;pending&#39;</span><span class="p">;</span>
            <span class="kr">const</span> <span class="nx">FULFILLED</span> <span class="o">=</span> <span class="s1">&#39;fulFilled&#39;</span><span class="p">;</span>
            <span class="kr">const</span> <span class="nx">REJECTED</span> <span class="o">=</span> <span class="s1">&#39;rejected&#39;</span><span class="p">;</span>
            <span class="kr">const</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">PENDING</span><span class="p">;</span>

            <span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 这里判断的原因就是Promise状态改为FULFILLED，不能再进行改变
</span><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">PENDING</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">FULFILLED</span><span class="p">;</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="kd">function</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 这里判断的原因跟上面一样
</span><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">PENDING</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">REJECTED</span><span class="p">;</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">reason</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="nx">exector</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上述resolve和reject方法中如果不进行判断，下面这种情况就会再次改变promise的状态：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-JavaScript" data-lang="JavaScript">        <span class="kd">let</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">rejrect</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">reject</span><span class="p">(</span><span class="s1">&#39;拒绝&#39;</span><span class="p">);</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="s1">&#39;解决&#39;</span><span class="p">);</span>
        <span class="p">})</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>上面这个例子，如果不进行判断，最终状态会是 fulfilled ，进行判断后状态是 rejected ，不会再被更改，这样才是满足Promise/A+规范的。</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-JavaScript" data-lang="JavaScript">        <span class="kr">class</span> <span class="nx">MyPromise</span> <span class="p">{</span>
            <span class="kr">static</span> <span class="nx">PENDING</span> <span class="o">=</span> <span class="s1">&#39;pending&#39;</span><span class="p">;</span>
            <span class="kr">static</span> <span class="nx">FULFILLED</span> <span class="o">=</span> <span class="s1">&#39;fulFilled&#39;</span><span class="p">;</span>
            <span class="kr">static</span> <span class="nx">REJECTED</span> <span class="o">=</span> <span class="s1">&#39;rejected&#39;</span><span class="p">;</span>
            <span class="nx">constructor</span><span class="p">(</span><span class="nx">executor</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">PENDING</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="c1">// 这个地方this.resolve只是拿到resolve方法，并不是this调用的
</span><span class="c1"></span>                    <span class="c1">// 事实上是全局对象调用的，但是class里面默认是严格模式
</span><span class="c1"></span>                    <span class="c1">// 如果不改变resolve的内部this指向，他的this是undefined
</span><span class="c1"></span>                    <span class="nx">executor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">resolve</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">reject</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">PENDING</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">FULFILLED</span><span class="p">;</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">reject</span><span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">PENDING</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">REJECTED</span><span class="p">;</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">reason</span> <span class="o">=</span> <span class="nx">reason</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// 测试
</span><span class="c1"></span>        <span class="kd">let</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">reject</span><span class="p">(</span><span class="s1">&#39;XKHM&#39;</span><span class="p">)</span>
        <span class="p">});</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<h2 id="2then方法">2.then方法</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-JavaScript" data-lang="JavaScript"><span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">onFulfilled</span><span class="p">,</span> <span class="nx">onRejected</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>1.then方法的两个参数onFulfilled和onRejected都是可选参数，如果这两个不是函数，将被忽略。</p>
<p>2.onFulfilled一定是在Promise执行完状态为fulFilled时调用，并接受一个参数value，并且最多被调用一次</p>
<p>3.onRejected一定是在Promise执行完状态为rejected时调用，并接受一个参数reason，并且最多被调用一次</p>
<p>4.onFulfilled和onRejected需要在下一轮事件循环中调用（异步调用）</p>
<p>5.onFulfilled和onRejected需要作为函数调用（没有自己的this值）</p>
<p>6.then方法可以被Promise链式调用</p>
<p>7.then方法必须返回一个Promise对象</p>
<p>提醒：</p>
<p>（1）then的时候需要处理Promise的三种状态，包括pending状态</p>
<p>（2）如果then本身在没经过处理的情况下就返回的是Promise，需要单独处理</p>
<h2 id="3promise解决过程">3.Promise解决过程</h2>
<p>Promise解决程序是一个抽象的操作，其需输入一个 promise 和一个值，我们表示为 [[Resolve]](promise, x)</p>
<p>1.如果Promise和x指向同一对象，以 TypeError 为据因拒绝执行 promise</p>
<p>2.如果 x 为 promise ，接受其状态</p>
<p>3.抑或 x 为对象或者函数</p>
<!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-JavaScript" data-lang="JavaScript">
        <span class="kr">class</span> <span class="nx">MyPromise</span> <span class="p">{</span>
            <span class="kr">static</span> <span class="nx">PENDING</span> <span class="o">=</span> <span class="s1">&#39;pending&#39;</span><span class="p">;</span>
            <span class="kr">static</span> <span class="nx">FULFILLED</span> <span class="o">=</span> <span class="s1">&#39;fulFilled&#39;</span><span class="p">;</span>
            <span class="kr">static</span> <span class="nx">REJECTED</span> <span class="o">=</span> <span class="s1">&#39;rejected&#39;</span><span class="p">;</span>
            <span class="nx">constructor</span><span class="p">(</span><span class="nx">executor</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">PENDING</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">callback</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="c1">// 这个地方this.resolve只是拿到resolve方法，并不是this调用的
</span><span class="c1"></span>                    <span class="c1">// 事实上是全局对象调用的，但是class里面默认是严格模式
</span><span class="c1"></span>                    <span class="c1">// 如果不改变resolve的内部this指向，他的this是undefined
</span><span class="c1"></span>                    <span class="nx">executor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">resolve</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">reject</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">PENDING</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">FULFILLED</span><span class="p">;</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">_</span> <span class="p">=&gt;</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">callFn</span> <span class="p">=&gt;</span> <span class="p">{</span>
                            <span class="nx">callFn</span><span class="p">.</span><span class="nx">onFulfilled</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
                        <span class="p">});</span>
                    <span class="p">})</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">reject</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">PENDING</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">REJECTED</span><span class="p">;</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">_</span> <span class="p">=&gt;</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">callFn</span> <span class="p">=&gt;</span> <span class="p">{</span>
                            <span class="nx">callFn</span><span class="p">.</span><span class="nx">onRejected</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
                        <span class="p">});</span>
                    <span class="p">})</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">then</span><span class="p">(</span><span class="nx">onFulfilled</span><span class="p">,</span> <span class="nx">onRejected</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">onFulfilled</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">onFulfilled</span> <span class="o">=</span> <span class="nx">value</span> <span class="p">=&gt;</span> <span class="nx">value</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">onRejected</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">onRejected</span> <span class="o">=</span> <span class="nx">value</span> <span class="p">=&gt;</span> <span class="nx">value</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="kd">let</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">PENDING</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                            <span class="nx">onFulfilled</span><span class="o">:</span> <span class="nx">value</span> <span class="p">=&gt;</span> <span class="p">{</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">onFulfilled</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">),</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span>
                            <span class="p">},</span>
                            <span class="nx">onRejected</span><span class="o">:</span> <span class="nx">value</span> <span class="p">=&gt;</span> <span class="p">{</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">onRejected</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">),</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span>
                            <span class="p">}</span>
                        <span class="p">})</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">FULFILLED</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">onFulfilled</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">),</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span>
                        <span class="p">})</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">REJECTED</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">onRejected</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">),</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span>
                        <span class="p">})</span>
                    <span class="p">}</span>
                <span class="p">});</span>
                <span class="k">return</span> <span class="nx">promise</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">parse</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">promise</span> <span class="o">==</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;then返回的promise不能是跟then是相同的Promise&#39;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">res</span> <span class="k">instanceof</span> <span class="nx">MyPromise</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">res</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">resolve</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-JavaScript" data-lang="JavaScript">        <span class="kr">class</span> <span class="nx">MyPromise</span> <span class="p">{</span>
            <span class="kr">static</span> <span class="nx">PENDING</span> <span class="o">=</span> <span class="s1">&#39;pending&#39;</span><span class="p">;</span>
            <span class="kr">static</span> <span class="nx">FULFILLED</span> <span class="o">=</span> <span class="s1">&#39;fulFilled&#39;</span><span class="p">;</span>
            <span class="kr">static</span> <span class="nx">REJECTED</span> <span class="o">=</span> <span class="s1">&#39;rejected&#39;</span><span class="p">;</span>
            <span class="nx">constructor</span><span class="p">(</span><span class="nx">executor</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">PENDING</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">callback</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="c1">// 这个地方this.resolve只是拿到resolve方法，并不是this调用的
</span><span class="c1"></span>                    <span class="c1">// 事实上是全局对象调用的，但是class里面默认是严格模式
</span><span class="c1"></span>                    <span class="c1">// 如果不改变resolve的内部this指向，他的this是undefined
</span><span class="c1"></span>                    <span class="nx">executor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">resolve</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">reject</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">PENDING</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">FULFILLED</span><span class="p">;</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">_</span> <span class="p">=&gt;</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">callFn</span> <span class="p">=&gt;</span> <span class="p">{</span>
                            <span class="nx">callFn</span><span class="p">.</span><span class="nx">onFulfilled</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
                        <span class="p">});</span>
                    <span class="p">})</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">reject</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">PENDING</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">REJECTED</span><span class="p">;</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">_</span> <span class="p">=&gt;</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">callFn</span> <span class="p">=&gt;</span> <span class="p">{</span>
                            <span class="nx">callFn</span><span class="p">.</span><span class="nx">onRejected</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
                        <span class="p">});</span>
                    <span class="p">})</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">then</span><span class="p">(</span><span class="nx">onFulfilled</span><span class="p">,</span> <span class="nx">onRejected</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">onFulfilled</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">onFulfilled</span> <span class="o">=</span> <span class="nx">value</span> <span class="p">=&gt;</span> <span class="nx">value</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">onRejected</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">onRejected</span> <span class="o">=</span> <span class="nx">value</span> <span class="p">=&gt;</span> <span class="nx">value</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="kd">let</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">PENDING</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                            <span class="nx">onFulfilled</span><span class="o">:</span> <span class="nx">value</span> <span class="p">=&gt;</span> <span class="p">{</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">onFulfilled</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">),</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span>
                            <span class="p">},</span>
                            <span class="nx">onRejected</span><span class="o">:</span> <span class="nx">value</span> <span class="p">=&gt;</span> <span class="p">{</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">onRejected</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">),</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span>
                            <span class="p">}</span>
                        <span class="p">})</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">FULFILLED</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">onFulfilled</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">),</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span>
                        <span class="p">})</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">REJECTED</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">onRejected</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">),</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span>
                        <span class="p">})</span>
                    <span class="p">}</span>
                <span class="p">});</span>
                <span class="k">return</span> <span class="nx">promise</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">parse</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">promise</span> <span class="o">==</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;then返回的promise不能是跟then相同的Promise&#39;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">res</span> <span class="k">instanceof</span> <span class="nx">MyPromise</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">res</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">resolve</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="kr">static</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">MyPromise</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">value</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">})</span>
            <span class="p">}</span>
            <span class="kr">static</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="nx">reject</span><span class="p">(</span><span class="nx">reason</span><span class="p">);</span>
                <span class="p">})</span>
            <span class="p">}</span>
            <span class="kr">static</span> <span class="nx">all</span><span class="p">(</span><span class="nx">promises</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nx">resolves</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="nx">promises</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                        <span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">value</span> <span class="p">=&gt;</span> <span class="p">{</span>
                            <span class="nx">resolves</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">resolves</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="nx">promises</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">resolve</span><span class="p">(</span><span class="nx">resolves</span><span class="p">);</span>
                            <span class="p">}</span>
                        <span class="p">},</span> <span class="nx">reason</span> <span class="p">=&gt;</span> <span class="p">{</span>
                            <span class="nx">reject</span><span class="p">(</span><span class="nx">reason</span><span class="p">);</span>
                        <span class="p">})</span>
                    <span class="p">})</span>
                <span class="p">})</span>
            <span class="p">}</span>
            <span class="kr">static</span> <span class="nx">race</span><span class="p">(</span><span class="nx">promises</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="nx">promises</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">promise</span> <span class="p">=&gt;</span> <span class="p">{</span>
                        <span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">value</span> <span class="p">=&gt;</span> <span class="p">{</span>
                            <span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
                        <span class="p">})</span>
                    <span class="p">})</span>
                <span class="p">})</span>
            <span class="p">}</span>
        <span class="p">}</span> 
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<h1 id="4测试">4.测试</h1>
<p>使用 <a href="https://github.com/promises-aplus/promises-tests">Promise/A+ 测试工具</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cmd" data-lang="cmd">npm install promises-aplus-tests -g
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cmd" data-lang="cmd">npx promises-aplus-tests promise.js
</code></pre></td></tr></table>
</div>
</div><h1 id="5提醒">5.提醒</h1>
<h2 id="1promise内部错误被吞掉了那是被谁吞掉的呢是被reject吞掉的">（1）Promise内部错误被吞掉了，那是被谁吞掉的呢，是被reject吞掉的</h2>
<!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-JavaScript" data-lang="JavaScript"><span class="kr">const</span> <span class="nx">pending</span> <span class="o">=</span> <span class="s1">&#39;pending&#39;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">fulFilled</span> <span class="o">=</span> <span class="s1">&#39;fulFilled&#39;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">rejected</span> <span class="o">=</span> <span class="s1">&#39;rejected&#39;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">resolveFn</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kr">const</span> <span class="nx">rejectFn</span> <span class="o">=</span> <span class="p">[];</span>

<span class="c1">// Promise/A+规范
</span><span class="c1"></span>
<span class="c1">// 1. Promise状态
</span><span class="c1"></span>
<span class="c1">// （1） 当Promise为pending状态时，可以被转换成另外两种状态
</span><span class="c1">// （2） 当Promise为fulFilled状态时，不能被更改，且必须有一个不能被更改的value值
</span><span class="c1">// （3） 当Promise为rejected状态时，不能被更改，且必须有一个不能被更改的reason值
</span><span class="c1"></span>
<span class="kd">function</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="nx">execute</span><span class="p">){</span>
    <span class="kr">const</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">pending</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">pending</span><span class="p">){</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">fulFilled</span><span class="p">;</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">reason</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">pending</span><span class="p">){</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">rejected</span><span class="p">;</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">reason</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 如果执行中有错误，会立马执行reject
</span><span class="c1"></span>    <span class="c1">// 也就是说Promise中的错误是被reject吞掉的
</span><span class="c1"></span>    <span class="c1">// try...catch是捕获不到的
</span><span class="c1"></span>    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">execute</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">);</span>   
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 2.then方法
</span><span class="c1"></span>
<span class="c1">// 首先，then方法是挂在Promise原型上的一个方法
</span><span class="c1"></span>
<span class="c1">// （1）then方法接收两个回调函数,如果不是函数忽略
</span><span class="c1">// （2）then方法返回一个Promise
</span><span class="c1">// （3）then方法需要异步执行
</span><span class="c1">// （4）then可以被链式调用
</span><span class="c1">// （5）如果onResolve是函数，必须在Promise状态为fulFilled后调用
</span><span class="c1">// （6）如果onRejected是函数，必须在Promise状态为rejected后调用
</span><span class="c1">// （7）then没有自己的this（也可以理解为then方法是挂在Promise原型上的）
</span><span class="c1"></span><span class="nx">MyPromise</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">then</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">onResolve</span><span class="p">,</span><span class="nx">onRejected</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">onResolve</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">onResolve</span> <span class="o">=</span> <span class="nx">value</span> <span class="p">=&gt;</span> <span class="nx">value</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">onRejected</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">onRejected</span> <span class="o">=</span> <span class="nx">reason</span> <span class="p">=&gt;</span> <span class="nx">reason</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">fulFilled</span><span class="p">){</span>
            <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">_</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="nx">onResolve</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
            <span class="p">})</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">rejected</span><span class="p">){</span>
            <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">_</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="nx">onRejected</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
            <span class="p">})</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="nx">p</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">// 测试
</span><span class="c1"></span><span class="k">try</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;抛出错误&#39;</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span> 
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// p.then();
</span><span class="c1"></span>
<span class="k">try</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;抛出错误&#39;</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">p1</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b80e64a53f0346c1b6feffde5015e649~tplv-k3u1fbpfcp-watermark.image" alt=""></p>
<!-- raw HTML omitted -->
<blockquote>
<p>Promise实例调用then时，如果then回调函数里面抛出了错误，也会被reject吞掉</p>
</blockquote>
<h1 id="6手写promise的意义">6.手写Promise的意义</h1>
<p>相当于照着一个规范然后用代码区实现，相当于深入了解源码，只是Promise源码才100多行，算阅读一个小型项目的源码把。</p>
<!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-JavaScript" data-lang="JavaScript"><span class="kr">const</span> <span class="nx">pending</span> <span class="o">=</span> <span class="s1">&#39;pending&#39;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">fulFilled</span> <span class="o">=</span> <span class="s1">&#39;fulFilled&#39;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">rejected</span> <span class="o">=</span> <span class="s1">&#39;rejected&#39;</span><span class="p">;</span>

<span class="c1">// Promise/A+规范
</span><span class="c1"></span>
<span class="c1">// 1. Promise状态
</span><span class="c1"></span>
<span class="c1">// （1） 当Promise为pending状态时，可以被转换成另外两种状态
</span><span class="c1">// （2） 当Promise为fulFilled状态时，不能被更改，且必须有一个不能被更改的value值
</span><span class="c1">// （3） 当Promise为rejected状态时，不能被更改，且必须有一个不能被更改的reason值
</span><span class="c1"></span>
<span class="kd">function</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="nx">execute</span><span class="p">){</span>
    <span class="kr">const</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">pending</span><span class="p">;</span>
    <span class="nx">that</span><span class="p">.</span><span class="nx">resolveFn</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">that</span><span class="p">.</span><span class="nx">rejectFn</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">_</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">pending</span><span class="p">){</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">fulFilled</span><span class="p">;</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">resolveFn</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">f</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="nx">f</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
                <span class="p">})</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">reason</span><span class="p">){</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">_</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">pending</span><span class="p">){</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">rejected</span><span class="p">;</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">reason</span><span class="p">;</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">rejectFn</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">f</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="nx">f</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
                <span class="p">})</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="p">}</span>

    <span class="c1">// 如果执行中有错误，会立马执行reject
</span><span class="c1"></span>    <span class="c1">// 也就是说Promise中的错误是被reject吞掉的
</span><span class="c1"></span>    <span class="c1">// try...catch是捕获不到的
</span><span class="c1"></span>    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">execute</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">);</span>   
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 2.then方法
</span><span class="c1"></span>
<span class="c1">// 首先，then方法是挂在Promise原型上的一个方法
</span><span class="c1"></span>
<span class="c1">// （1）then方法接收两个回调函数,如果不是函数忽略
</span><span class="c1">// （2）then方法返回一个Promise
</span><span class="c1">// （3）then方法需要异步执行
</span><span class="c1">// （4）then可以被链式调用
</span><span class="c1">// （5）如果onResolve是函数，必须在Promise状态为fulFilled后调用
</span><span class="c1">// （6）如果onRejected是函数，必须在Promise状态为rejected后调用
</span><span class="c1">// （7）then没有自己的this（也可以理解为then方法是挂在Promise原型上的）
</span><span class="c1"></span><span class="nx">MyPromise</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">then</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">onResolve</span><span class="p">,</span><span class="nx">onRejected</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">onResolve</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">){</span>
        <span class="nx">onResolve</span> <span class="o">=</span> <span class="nx">value</span> <span class="p">=&gt;</span> <span class="nx">value</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">onRejected</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">){</span>
        <span class="nx">onRejected</span> <span class="o">=</span> <span class="nx">reason</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nx">reason</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kr">const</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">promise</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">fulFilled</span><span class="p">){</span>
        <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">_</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="kd">let</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">onResolve</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
                    <span class="nx">resolvePromise</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span><span class="nx">x</span><span class="p">,</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="p">})</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">rejected</span><span class="p">){</span>
        <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">_</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="kd">let</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">onRejected</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
                    <span class="nx">resolvePromise</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span><span class="nx">x</span><span class="p">,</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
                <span class="p">}</span>   
            <span class="p">})</span>
        <span class="p">})</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">pending</span><span class="p">){</span>
        <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">resolveFn</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="kd">let</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">onResolve</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
                    <span class="nx">resolvePromise</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span><span class="nx">x</span><span class="p">,</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">})</span>

            <span class="nx">that</span><span class="p">.</span><span class="nx">rejectFn</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="kd">let</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">onRejected</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
                    <span class="nx">resolvePromise</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span><span class="nx">x</span><span class="p">,</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
                <span class="p">}</span>   
            <span class="p">})</span>
        <span class="p">})</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 3.Promise执行程序
</span><span class="c1"></span>
<span class="c1">// 1.promise和x指向同一个对象，执行reject()
</span><span class="c1">// 2.x是promise，采用它的状态
</span><span class="c1">// 3.x是对象或函数，处理
</span><span class="c1">// 4.then不是函数
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">resolvePromise</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span><span class="nx">x</span><span class="p">,</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">promise</span> <span class="o">===</span> <span class="nx">x</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;promise不能和x相等&#39;</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">x</span> <span class="k">instanceof</span> <span class="nx">MyPromise</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">fulFilled</span><span class="p">){</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">rejected</span><span class="p">){</span>
            <span class="nx">reject</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="nx">x</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">y</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="nx">resolvePromise</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span>
            <span class="p">},</span><span class="nx">reject</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">x</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">x</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)){</span>
        <span class="kd">let</span> <span class="nx">executed</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">then</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">then</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">then</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">){</span>
                <span class="nx">then</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">executed</span><span class="p">){</span>
                        <span class="k">return</span> <span class="kc">false</span>
                    <span class="p">}</span>
                    <span class="nx">executed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="nx">resolvePromise</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span>
                <span class="p">},</span><span class="nx">e</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">executed</span><span class="p">){</span>
                        <span class="k">return</span> <span class="kc">false</span>
                    <span class="p">}</span>
                    <span class="nx">executed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                <span class="p">})</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="nx">resolve</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">executed</span><span class="p">){</span>
                <span class="k">return</span> <span class="kc">false</span>
            <span class="p">}</span>
            <span class="nx">executed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->

    </div>

    
    


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://xkhm.net/tags/promise/">Promise</a>
          <a href="https://xkhm.net/tags/%E6%89%8B%E5%86%99promise/">手写Promise</a>
          <a href="https://xkhm.net/tags/%E6%8F%90%E6%A1%B6/">提桶</a>
          <a href="https://xkhm.net/tags/javascript/">JavaScript</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/node%E6%96%87%E4%BB%B6%E5%A4%B9%E8%AF%BB%E5%8F%96/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default" style="position: relative;top: -2px;">Node文件夹读取</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/javascript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/">
            <span class="next-text nav-default" style="position: relative;top: -3px;">JavaScript异步编程</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  















        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="im.xkhm@gmail.com" rel="me noopener" class="iconfont"
      title="email"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/yukiyukixing" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://www.zhihu.com/people/yuki-42-63" rel="me noopener" class="iconfont"
      title="zhihu"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M351.791182 562.469462l192.945407 0c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262l159.282726 0c0 0-0.86367-67.402109-18.578124-67.402109s-279.979646 0-279.979646 0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461c-4.536316 12.313443 24.62791 5.832845 36.941354 0 12.313443-5.832845 68.050885-25.924439 84.252893-103.69571l86.570681 0c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262L109.86113 490.530013c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449L279.868105 562.469462c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513 0 0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-0.055259 0.185218 167.855986 193.263655c0 0 22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-0.045025 0.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"></path>
  <path d="M584.918753 182.033893l0 668.840094 70.318532 0 28.807093 80.512708 121.875768-80.512708 153.600307 0L959.520453 182.033893 584.918753 182.033893zM887.150192 778.934538l-79.837326 0-99.578949 65.782216-23.537066-65.782216-24.855084 0L659.341766 256.673847l227.807403 0L887.149169 778.934538z"></path>
</svg>

    </a>


<a href="https://xkhm.net/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
  
</div>

<div class="copyright">
  
  
  <span class="copyright-year">
    &copy;
    
    2019 -
    2023
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
      星空海绵
      
    </span></span>
  
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//changkun.de/urlstat/client.js"></script>












</body>
</html>
